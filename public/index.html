<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHP CLI Terminal</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'SF Mono',Consolas,monospace;background:#050505;color:#00ff41;height:100vh;overflow:hidden}
        .terminal{height:100vh;display:flex;flex-direction:column;text-shadow:0 0 5px rgba(0,255,65,.1);position:relative}
        .terminal::after{content:'';position:absolute;inset:0;background:linear-gradient(rgba(18,16,16,0) 50%,rgba(0,0,0,.25) 50%),linear-gradient(90deg,rgba(255,0,0,.06),rgba(0,255,0,.02),rgba(0,0,255,.06));background-size:100% 2px,3px 100%;pointer-events:none}
        .output{flex:1;padding:10px;overflow-y:auto;font-size:1rem;line-height:1.5;white-space:pre-wrap;word-break:break-all;user-select:text}
        .line{color:#e0e0e0}
        .input{display:flex;align-items:center}
        .prompt{color:#00ff41;font-weight:bold;margin-right:8px;white-space:nowrap}
        input{flex:1;background:0;border:0;color:#00ff41;font:inherit;outline:0;padding:0;caret-color:#00ff41}
        .cmd{color:#f1fa8c}
        .err{color:#ff6b6b}
        .ok{color:#50fa7b}
        .load{color:#f1fa8c}
        .output::-webkit-scrollbar{width:10px}
        .output::-webkit-scrollbar-track{background:#050505}
        .output::-webkit-scrollbar-thumb{background:#555}
        .output::-webkit-scrollbar-thumb:hover{background:#777}
        .ansi-31{color:#ff6b6b}
        .ansi-32{color:#50fa7b}
        .ansi-33{color:#f1fa8c}
        .ansi-34,.ansi-36{color:#8be9fd}
        .ansi-35{color:#ff79c6}
        .ansi-37{color:#f8f8f2}
        .ansi-1{font-weight:bold}
    </style>
</head>
<body>
    <div class="terminal">
        <div class="output" id="o"></div>
    </div>
    <script>
        class Terminal{
            constructor(){
                this.o=document.getElementById('o');
                this.h=[];
                this.hi=-1;
                this.p=false;
                this.pr='user@php-cli:~$';
                this.init();
            }
            
            init(){
                this.add('PHP CLI Terminal Interface v1.0.0');
                this.add('Connected to PHP CLI Application.');
                this.add("Type 'help' for available commands.");
                this.add('');
                this.newLine();
                document.body.onclick=e=>{
                    if(!window.getSelection().toString()&&(!this.o.contains(e.target)||e.target.closest('.input')))
                        this.i.focus();
                };
                document.onkeydown=e=>{
                    if(!window.getSelection().toString()&&document.activeElement!==this.i&&!this.p&&e.key.length===1)
                        this.i.focus();
                };
            }
            
            newLine(){
                this.l=document.createElement('div');
                this.l.className='input';
                this.l.innerHTML=`<span class="prompt">${this.pr}</span><input autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">`;
                this.o.appendChild(this.l);
                this.i=this.l.querySelector('input');
                this.i.onkeydown=e=>this.key(e);
                if(!this.p&&!window.getSelection().toString())
                    setTimeout(()=>this.i.focus(),10);
                this.scroll();
            }
            
            key(e){
                if(e.key==='Enter'){
                    e.preventDefault();
                    this.exec();
                }else if(e.key==='ArrowUp'){
                    e.preventDefault();
                    this.nav(-1);
                }else if(e.key==='ArrowDown'){
                    e.preventDefault();
                    this.nav(1);
                }else if(e.key==='Tab'){
                    e.preventDefault();
                }
            }
            
            nav(d){
                if(!this.h.length)return;
                this.hi-=d;
                if(this.hi<0){
                    this.hi=-1;
                    this.i.value='';
                    return;
                }
                if(this.hi>=this.h.length)this.hi=this.h.length-1;
                this.i.value=this.h[this.hi]||'';
                this.i.setSelectionRange(this.i.value.length,this.i.value.length);
            }
            
            async exec(){
                if(this.p)return;
                const c=this.i.value.trim();
                this.l.innerHTML=`<span class="prompt">${this.pr}</span> <span class="cmd">${this.esc(c)}</span>`;
                if(!c){
                    this.newLine();
                    return;
                }
                this.h.unshift(c);
                this.hi=-1;
                this.p=true;
                const load=this.add('<span class="load">Executing...</span>');
                try{
                    const r=await this.send(c);
                    this.rm(load);
                    this.handle(r);
                }catch(e){
                    this.rm(load);
                    this.add(`<span class="err">Error: ${e.message}</span>`);
                }finally{
                    this.p=false;
                    this.newLine();
                }
            }
            
            async send(c){
                const r=await fetch('/api/cli-command',{
                    method:'POST',
                    headers:{'Content-Type':'application/x-www-form-urlencoded'},
                    body:`command=${encodeURIComponent(c)}`
                });
                if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                return await r.json();
            }
            
            handle(r){
                let o='',e=null;
                if(r.success){
                    o=r.body.output||'';
                    e=r.body.exit_code;
                }else{
                    const d=r.error?.details;
                    o=d?.output||r.error?.message||r.message||'Unknown error';
                    e=d?.exit_code;
                }
                if(o)this.add(this.ansi(o.trim()));
                if(e&&e!==0)this.add(`<span class="err">Process exited with code ${e}</span>`);
            }
            
            ansi(t){
                return t.replace(/\u001b\[(\d+)(;(\d+))*m/g,(m,p1)=>{
                    const c=parseInt(p1,10);
                    switch(c){
                        case 0:return '';
                        case 1:return '<span class="ansi-1">';
                        case 31:return '<span class="ansi-31">';
                        case 32:return '<span class="ansi-32">';
                        case 33:return '<span class="ansi-33">';
                        case 34:return '<span class="ansi-34">';
                        case 35:return '<span class="ansi-35">';
                        case 36:return '<span class="ansi-36">';
                        case 37:return '<span class="ansi-37">';
                        default:return '';
                    }
                })+'</span>';
            }
            
            add(c){
                const e=document.createElement('div');
                e.className='line';
                e.innerHTML=c||' ';
                this.o.appendChild(e);
                this.scroll();
                return e;
            }
            
            rm(e){
                if(e?.parentNode)e.parentNode.removeChild(e);
            }
            
            scroll(){
                this.o.scrollTop=this.o.scrollHeight;
            }
            
            esc(t){
                const d=document.createElement('div');
                d.textContent=t;
                return d.innerHTML;
            }
        }
        
        document.addEventListener('DOMContentLoaded',()=>new Terminal());
    </script>
</body>
</html>